const path = require('path');
const webpack = require('webpack');
const express = require('express');
const morgan = require('morgan');
const open = require('open');
const cors = require('cors');
const fs = require('fs');

const app = express();

module.exports = (directory) => {
  if (directory !== '' || directory !== undefined) {
    fs.readdir(path.resolve(__dirname, directory), (err, items) => {
      if (!err) {
        for (var i=0; i<items.length; i++) {
          if (/^(index|default)\.html?$/g.test(items[i])) {

            app.use(morgan('dev'));
            app.use(express.static(path.join(__dirname, directory)))
            app.use(cors());

            app.get('*', (req, res) => {
              res.sendFile(path.join(__dirname, `${directory}/${items[i]}`));
            });

            app.listen(3000, (err) => {
              if (err) {
                return console.error(err);
              }
              console.log('Listening at http://localhost:3000/');
              setTimeout(() => {
                open('http://127.0.0.1:3000/', (err) => {
                  if (err) {
                    console.log(err);
                  }
                });
              }, 2000);
            });
            break;
          }
        }
      } else {
        throw new Error('Directory not found');
      }
    });
  } else {
    throw new Error('Directory not valid.');
  }
}
